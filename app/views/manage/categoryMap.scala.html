@import helper._
@import models.entities.KbjCategory
@import models.entities.form.BindCategory
@(kbjFatherCates: List[KbjCategory], cateMap: Form[BindCategory], cateMapBind: Form[BindCategory], mallCates: List[BindCategory])
@implicitFieldConstructor = @{
  b3.horizontal.fieldConstructor("col-md-2", "col-md-3")
}

@views.html.manage.manageMain() {
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-2" >
      @views.html.manage.leftMenu.render
      </div><!--col-md-2 -->
      <div class="col-md-10">
          <!--画面内容-->
        <div class="content-box-large min-height">
          <h2>品类映射</h2>
          <input type="hidden" id="menu" value="23">
          <div class="content-box-large">
            @b3.form(gui.manage.routes.CategoryController.getMallCates(), 'id -> "cateMapForm") {
              @CSRF.formField
              @b3.hidden(cateMap("rootCate"), 'id -> "hidRootCate")
              @b3.hidden(cateMap("leafCate"), 'id -> "hidLeafCate")
              @b3.hidden(cateMap("mall"), 'id -> "hidMall")
              @b3.hidden(cateMap("keyWord"), 'id -> "hidKeyWord")
              @b3.hidden(cateMap("isBind"), 'id -> "hidBindSearch")
            }
            <div class="row">
              <h4>选择可比价分类</h4>
              <div class="row">
                <div class="form-group col-sm-5">
                  <label class="col-sm-3 control-label">
                    父分类
                  </label>
                  <div class="col-sm-8">
                    <select class="form-control col-3" id="cate-root" onchange="createSelect('choose')">
                      <option value="0">---请选择父分类---</option>
                      @for(kbjFatherCate <- kbjFatherCates) {
                        <option value="@kbjFatherCate.id">@kbjFatherCate.name</option>
                      }
                    </select>
                  </div>
                </div>
                <div class="form-group col-sm-5">
                  <label class="col-sm-3 control-label">
                    子分类
                  </label>
                  <div class="col-sm-8">
                    <select class="form-control col-3" id="cate-leaf" onchange="createLeafSelect('choose')">
                      <option value="0"></option>
                    </select>
                  </div>
                </div>
                @*<button type="button" id="kbjConfirm" class="col-sm-1 btn btn-primary" disabled="disabled">确定</button>*@
              </div>

              <h4>品类绑定</h4>
              <div class="row">
                <div class="form-group col-sm-5">
                  <label class="col-sm-3 control-label">
                    选择商城
                  </label>
                  <div class="col-sm-8">
                    <select class="form-control col-3" id="mallSelect">
                      <option value="ALL" @if(cateMap.get().mall == "ALL") {selected}>---可选择商城---</option>
                      <option value="JD"  @if(cateMap.get().mall == "JD") {selected}>京东</option>
                      <option value="TMALL"  @if(cateMap.get().mall == "TMALL") {selected}>天猫</option>
                      <option value="SUNING" @if(cateMap.get().mall == "SUNING") {selected}>苏宁</option>
                    </select>
                  </div>
                </div>
                <div class="form-group col-sm-5">
                  <label class="col-sm-3 control-label">
                    关键字
                  </label>
                  <div class="col-sm-8">
                    <input type="text" id="keyword" class="form-control" value="@cateMap.get().keyWord" placeholder="请输入检索关键字">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="form-group col-sm-5">
                  <label class="col-sm-3 control-label">
                    是否绑定
                  </label>
                  <div class="col-sm-8">
                    <select class="form-control col-3" id="bindSelect">
                      <option value="ALL" @if(cateMap.get().isBind == "ALL") {selected}>---可选择是否绑定---</option>
                      <option value="0" @if(cateMap.get().isBind == "0") {selected}>未绑定</option>
                      <option value="1" @if(cateMap.get().isBind == "1") {selected}>已绑定</option>
                    </select>
                  </div>
                </div>
                <button type="button" id="searchConfirm" class="col-sm-1 col-xs-offset-5 btn btn-primary" onclick="searchConfirm()" disabled="disabled">检索</button>
              </div>
            </div>

            @*检索结果*@
            <div class="row" style="margin-top: 15px">
              @b3.form(gui.manage.routes.CategoryController.edit(), 'id -> "bindCateForm") {
                @CSRF.formField
                @b3.hidden(cateMapBind("rootCate"), 'id -> "hidBindRoot")
                @b3.hidden(cateMapBind("leafCate"), 'id -> "hidBindLeaf")
                @b3.hidden(cateMapBind("mall"), 'id -> "hidBindMall")
                @b3.hidden(cateMapBind("keyWord"), 'id -> "hidBindKey")
                @b3.hidden(cateMapBind("isBind"), 'id -> "hidBind")
                <form>
              <table class="table mallCateTable">
                <thead>
                  <tr>
                    <th class="col-sm-1">是否已绑定</th>
                    <th class="col-sm-1">商城名</th>
                    <th class="col-sm-2">分类名</th>
                    <th class="col-sm-2">TAG</th>
                    <th class="col-sm-2">分类url</th>
                  </tr>
                </thead>
                <input type="hidden" id="hidType" value="1">
                <tbody id="searchTbody">
                  @for((mallCate, idx) <- mallCates.zipWithIndex) {
                  @b3.hidden(cateMapBind("mapId"), 'id -> ("hidMapId"+ String.valueOf(idx)))
                  @b3.hidden(cateMapBind("mallCateId"), 'id -> ("hidMallCateId"+ String.valueOf(idx)))
                  @b3.hidden(cateMapBind("bindFlg"), 'id -> ("hidBindFlg" + String.valueOf(idx)))
                  @b3.hidden(cateMapBind("chgFlg"), 'id -> ("hidChgFlg" + String.valueOf(idx)))
                  <tr>
                    @if(mallCate.mapId != null) {
                      <input type="hidden" value="@mallCate.mapId" id="mapId@idx">
                    }
                    <input type="hidden" value="@mallCate.mallCateId" id="mallCateId@idx">
                    <th class="col-sm-1">
                      <input type="checkbox" style="width: 16px; height: 16px" value="@mallCate.isBind" id="bindBox@idx" @if(("1").equals(mallCate.isBind)){checked=“checked"} onchange="valChange(@idx)">
                      <input type="hidden" value="@mallCate.isBind" id="hidBindBox@idx">
                    </th>
                    <th class="col-sm-1">@mallCate.mall</th>
                    <th class="col-sm-2">@mallCate.name</th>
                    <th class="col-sm-3" title="@mallCate.tag">@mallCate.tag</th>
                    <th class="col-sm-3" title="@mallCate.link">@if(mallCate.link.length>20) {@mallCate.link.substring(0,20)...} @if(mallCate.link.length<=20) {@mallCate.link.substring(0,20)...}</th>
                  </tr>
                  }
                </tbody>
              </table>
                </form>
              }
            </div>
            @if(mallCates.size() > 0) {
              <div class="row">
                <button type="button" id="bindConfirm" class="col-sm-1 col-xs-offset-10 btn btn-primary" onclick="bindConfirm()">绑定更新</button>
              </div>
            }
            @if(mallCates.size() == 0) {
              <div class="row" style="text-align: center">
                <span>暂无搜索结果！</span>
              </div>
            }
            <div class="row" style="text-align: center" id="noResult" hidden="hidden"><span>暂无搜索结果！</span></div>

            <!-- 模态框（Modal） -->
            <div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">提醒</h4>
                  </div>
                  <div class="modal-body" id="modalBody" style="color: darkred"></div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="dismissButton">取消</button>
                    <button type="button" class="btn btn-primary" id="comfirmButton" onclick="confirmSelect()">继续</button>
                  </div>
                </div><!-- /.modal-content -->
              </div><!-- /.modal -->
            </div>

          </div>
        </div><!--content-box-large-->
      </div><!--col-md-10 -->
    </div><!--row-->
  </div><!--container-fluid-->
}

  <script type="text/javascript">
    $(document).ready(function() {
      if (@cateMap.get().rootCate + "" != "") {
        $("#cate-root").val(@cateMap.get().rootCate);
        createSelect("ready");
      }
    });

    /**
     * type: 区分是画面自动加载还是select框自己选
     * ajax获取子类
     */
    function createSelect(type) {
      if (@mallCates.size() > 0 && type == "choose" && $("#hidType").val() == 1) {
        clearDatail();
      }

      $("#searchConfirm").attr("disabled", "disabled");

      var cateRootId = $("#cate-root option:selected").val();
      if (cateRootId != 0) {
        $.ajax({
          type: "get",
          url: "/manage/cate/map/getleafcate/" + cateRootId,
          dataType: "json",
          success: function(data) {
            $("#cate-leaf").empty();
            $("#cate-leaf").append("<option value = '0'>---请选择子分类---</option>");

            for(var i = 0; i < data.length; i++ ) {
              $("#cate-leaf").append("<option value = " + data[i].id + ">" + data[i].name + "</option>");
            }

            if (type == "ready" && @cateMap.get().leafCate + "" != "") {
              $("#cate-leaf").val(@cateMap.get().leafCate);
              createLeafSelect("ready");
            }
          },
          error: function() {
            alert("ajax error");
          }
        })
      } else {
        $("#cate-leaf").empty();
        $("#cate-leaf").append("<option value = '0'></option>");
      }
    }

    /**
     * 设置选择按钮活性
     */
    function createLeafSelect(type) {
      if (@mallCates.size() > 0 && type == "choose" && $("#hidType").val() == 1) {
        clearDatail();
      }
      var cateLeafId = $("#cate-leaf").val();
      if (cateLeafId != 0) {
        $("#searchConfirm").removeAttr("disabled");
      } else {
        $("#searchConfirm").attr("disabled", "disabled");
      }
    }

    /**
     * 当检索有值的时候，改变可比价分类清空检索结果
     */
    function clearDatail() {
      $("#modalBody").text("如果更改可比价分类的值搜索结果将会被清空!");
      $("#modalBody").append("<h4 class='row' style='color: black'>是否继续?</h4>");
      $('#confirmModal').modal('show');
    }

    /**
     *  检索设置提交表单值
     */
    function searchConfirm() {
      $("#hidRootCate").val($("#cate-root option:selected").val());
      $("#hidLeafCate").val($("#cate-leaf option:selected").val());
      $("#hidMall").val($("#mallSelect").val());
      $("#hidKeyWord").val($("#keyword").val());
      $("#hidBindSearch").val($("#bindSelect").val());
      $("#cateMapForm").submit();
    }

    /**
     *  绑定更新
     */
    function bindConfirm() {
      $("#bindCateForm").submit();
    }

    /**
     * 确定重选可比价分类
     */
    function confirmSelect() {
      $("#hidType").val(0);
      $("#searchTbody").html("");
      $("#bindConfirm").hide();
      $("#noResult").show();
      $('#confirmModal').modal('hide');
    }

    /**
     * 选择绑定还是解绑
     */
    function valChange(idx) {
      $("#hidMallCateId" + idx).val($("#mallCateId" + idx).val());
      $("#hidMapId" + idx).val($("#mapId" + idx).val());

      if($("#bindBox" + idx).is(':checked') == true) {
        $("#hidBindFlg" + idx).val("1");
      } else {
        $("#hidBindFlg" + idx).val("0");
      }

      //判断是否有改变
      if ($("#hidBindBox" + idx).val() === $("#hidBindFlg" + idx).val()) {
        $("#hidChgFlg" + idx).val(0);
      } else {
        $("#hidChgFlg" + idx).val(1);
      }
//      alert($("#hidChgFlg" + idx).val());
    }

  </script>